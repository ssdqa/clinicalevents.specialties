# Clinical Events and Specialties – Output Generation

Using BOTH tabular outputs generated by `cnc_sp_process`, this function
will build a graph to visualize the results. Each function configuration
will output a bespoke ggplot. Theming can be adjusted by the user after
the graph has been output using `+ theme()`. Most graphs can also be
made interactive using `make_interactive_squba()`

## Usage

``` r
cnc_sp_output(
  cnc_sp_process_output,
  cnc_sp_process_names,
  facet_vars = NULL,
  top_n = 15,
  n_mad = 3L,
  specialty_filter = NULL,
  p_value = 0.9,
  large_n = FALSE,
  large_n_sites = NULL
)
```

## Arguments

- cnc_sp_process_output:

  *tabular input* \|\| **required**

  The tabular output (with visit-based counts per specialty) produced by
  `cnc_sp_process`

- cnc_sp_process_names:

  *tabular input* \|\| **required**

  The tabular output (with specialty names & any specialty_name grouping
  categories) produced by `cnc_sp_process`

  To see an example of what this file should look like, see
  [`?clinicalevents.specialties::cnc_sp_specialty_names`](https://ssdqa.github.io/clinicalevents.specialties/reference/cnc_sp_specialty_names.md)

- facet_vars:

  *string or vector* \|\| defaults to `NULL`

  A string or vector representing the variables by which the plot should
  be facet. Accepted values are `cluster` and/or `visit_type`

- top_n:

  *integer* \|\| defaults to `15`

  An integer value indicating the cutoff for the top N of each group to
  display per check

- n_mad:

  *integer* \|\| defaults to `3`

  An integer indicating the number of MAD from the median that should be
  considered the threshold for an anomalous value

- specialty_filter:

  *string or vector* \|\| defaults to `NULL`

  An optional parameter indicating the specialty or specialties to limit
  to in the analysis

- p_value:

  *numeric* \|\| defaults to `0.9`

  The p value to be used as a threshold in the Multi-Site, Anomaly
  Detection, Cross-Sectional analysis

- large_n:

  *boolean* \|\| defaults to `FALSE`

  For Multi-Site analyses, a boolean indicating whether the large N
  visualization, intended for a high volume of sites, should be used.
  This visualization will produce high level summaries across all sites,
  with an option to add specific site comparators via the
  `large_n_sites` parameter.

- large_n_sites:

  *vector* \|\| defaults to `NULL`

  When `large_n = TRUE`, a vector of site names that can add site-level
  information to the plot for comparison across the high level summary
  information.

## Value

This function will produce a graph to visualize the results from
`cnc_sp_process` based on the parameters provided. The default output is
typically a static ggplot or gt object, but interactive elements can be
activated by passing the plot through `make_interactive_squba`. For a
more detailed description of output specific to each check type, see the
PEDSpace metadata repository

## Examples

``` r
#' Source setup file
source(system.file('setup.R', package = 'clinicalevents.specialties'))

#' Create in-memory RSQLite database using data in extdata directory
conn <- mk_testdb_omop()

#' Establish connection to database and generate internal configurations
initialize_dq_session(session_name = 'cnc_sp_process_test',
                      working_directory = my_directory,
                      db_conn = conn,
                      is_json = FALSE,
                      file_subdirectory = my_file_folder,
                      cdm_schema = NA)
#> Connected to: :memory:@NA
#> To see environment settings, run `get_argos_default()`

## Turn off SQL trace for this example
config('db_trace', FALSE)

#' Build mock study cohort
cohort <- cdm_tbl('person') %>% dplyr::distinct(person_id) %>%
  dplyr::mutate(start_date = as.Date(-5000),
                #RSQLite does not store date objects,
                #hence the numerics
                end_date = as.Date(15000),
                site = ifelse(person_id %in% c(1:6), 'synth1', 'synth2'))

#' Prepare input tables
cnc_sp_visit_tbl <- dplyr::tibble(visit_concept_id = c(9201,9202,9203),
                                  visit_type = c('inpatient', 'outpatient', 'emergency'))

cnc_sp_concept_tbl <- dplyr::tibble(domain = 'Hypertension',
                                    domain_tbl = 'condition_occurrence',
                                    concept_field = 'condition_concept_id',
                                    date_field = 'condition_start_date',
                                    vocabulary_field = NA,
                                    codeset_name = 'dx_hypertension')

#' Execute `cnc_sp_process` function
#' This example will use the single site, exploratory, cross sectional
#' configuration
cnc_sp_process_example <- cnc_sp_process(cohort = cohort,
                                         omop_or_pcornet = 'omop',
                                         multi_or_single_site = 'single',
                                         anomaly_or_exploratory = 'exploratory',
                                         codeset_tbl = cnc_sp_concept_tbl,
                                         visit_type_tbl = cnc_sp_visit_tbl,
                                         time = FALSE)
#> Rows: 77 Columns: 5
#> ── Column specification ────────────────────────────────────────────────────────
#> Delimiter: ","
#> chr (5): module, check, Always Required, Required for Check, Optional
#> 
#> ℹ Use `spec()` to retrieve the full column specification for this data.
#> ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
#> Preparing cohort
#> Joining with `by = join_by(person_id, start_date, end_date, site, site_summ, fu_diff, fu)`
#> Computing specialty concordance
#> Starting codeset dx_hypertension
#> Joining with `by = join_by(person_id)`
#> Finding code occurrences
#> Joining with `by = join_by(person_id)`
#> Joining with `by = join_by(concept_id)`
#> Finding specialties
#> Joining with `by = join_by(person_id)`
#> Joining with `by = join_by(visit_occurrence_id)`
#> Joining with `by = join_by(visit_occurrence_id)`
#> Both tables required for output generation have been output in a list.
#> ! Be sure to classify the specialties into groups in the specialty_name field of `cnc_sp_process_names`
#> ┌ Output Function Details ─────────────────────────────────────────┐
#> │ You can optionally use this dataframe in the accompanying        │
#> │ `cnc_sp_output` function. Here are the parameters you will need: │
#> │                                                                  │
#> │ Always Required: cnc_sp_process_output, cnc_sp_process_names     │
#> │ Required for Check: top_n                                        │
#> │ Optional: facet_vars, specialty_filter                           │
#> │                                                                  │
#> │ See ?cnc_sp_output for more details.                             │
#> └──────────────────────────────────────────────────────────────────┘

cnc_sp_process_example$cnc_sp_process_output
#> # A tibble: 1 × 7
#>   specialty_concept_id cluster          visit_type codeset_name num_visits site 
#>                  <dbl> <chr>            <chr>      <chr>             <int> <chr>
#> 1             38004446 Essential hyper… outpatient dx_hyperten…          5 comb…
#> # ℹ 1 more variable: output_function <chr>
cnc_sp_process_example$cnc_sp_process_names
#> # A tibble: 1 × 2
#>   specialty_concept_id specialty_concept_name   
#>                  <dbl> <chr>                    
#> 1             38004446 No vocabulary table input

#' Execute `cnc_sp_output` function
cnc_sp_output_example <-
  cnc_sp_output(cnc_sp_process_output =
                  cnc_sp_process_example$cnc_sp_process_output,
                cnc_sp_process_names =
                  cnc_sp_process_example$cnc_sp_process_names %>%
                    dplyr::mutate(specialty_name = 'General Pediatrics'),
                facet_vars = c('visit_type'))
#> Preparing data for visualization
#> Joining with `by = join_by(codeset_name, visit_type)`
#> Building visualization
#> Joining with `by = join_by(codeset_name, visit_type, specialty_name, n, total,
#> prop)`

cnc_sp_output_example


#' Easily convert the graph into an interactive ggiraph or plotly object with
#' `make_interactive_squba()`

make_interactive_squba(cnc_sp_output_example)

{"x":{"data":[{"orientation":"v","width":1,"base":0.55000000000000004,"x":[0.5],"y":[0.89999999999999991],"text":"Specialty:  General Pediatrics <br />Number of Visits:  5 <br />Proportion:  1","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(255,77,111,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"name":"General Pediatrics","legendgroup":"General Pediatrics","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":52.529680365296812,"r":7.3059360730593621,"b":37.260273972602747,"l":130.77625570776257},"paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"title":{"text":"Proportion of Visits with each of the top 15 Specialties","font":{"color":"rgba(0,0,0,1)","family":"","size":17.534246575342465},"x":0,"xref":"paper"},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.050000000000000003,1.05],"tickmode":"array","ticktext":["0.00","0.25","0.50","0.75","1.00"],"tickvals":[0,0.25,0.5,0.75,1],"categoryorder":"array","categoryarray":["0.00","0.25","0.50","0.75","1.00"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0,"zeroline":false,"anchor":"y","title":"","hoverformat":".2f"},"annotations":[{"text":"Proportion","x":0.5,"y":0,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"top","annotationType":"axis","yshift":-21.917808219178088},{"text":"Specialty","x":0,"y":0.5,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-90,"xanchor":"right","yanchor":"center","annotationType":"axis","xshift":-115.43378995433793},{"text":"outpatient","x":0.5,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.68949771689498},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"}],"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.40000000000000002,1.6000000000000001],"tickmode":"array","ticktext":["General Pediatrics"],"tickvals":[1],"categoryorder":"array","categoryarray":["General Pediatrics"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0,"zeroline":false,"anchor":"x","title":"","hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","layer":"below","x0":0,"x1":1,"y0":0,"y1":1},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","layer":"below","x0":0,"x1":1,"y0":0,"y1":23.37899543378996,"yanchor":1,"ysizemode":"pixel"}],"showlegend":true,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498},"title":{"text":"","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"1c0b9bff108":{"x":{},"y":{},"fill":{},"text":{},"type":"bar"}},"cur_data":"1c0b9bff108","visdat":{"1c0b9bff108":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}
```
